<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="theme-color" content="#3B82F6">
  <title>Pengingat PR - Aplikasi Pengelola Tugas Sekolah</title>
  <style>
    /* Splash Screen Styles */
    #splash {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #000;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      cursor: pointer; /* Tambahkan kursor */
    }
    #introVideo {
      max-width: 100%;
      max-height: 100%;
    }
    #mainContent {
      display: none;
    }
    /* Existing Styles */
    :root {
      --primary: #3B82F6;
      --primary-600: #2563EB;
      --bg: #f8fafc;
      --card: #ffffff;
      --muted: #6b7280;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --glass: rgba(255,255,255,0.5);
      --radius: 14px;
      --shadow: 0 6px 18px rgba(16,24,40,0.06);
      --priority-high: #ef4444;
      --priority-medium: #f59e0b;
      --priority-low: #10b981;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    .dark-mode {
      --bg: #0b1220;
      --card: #0f1724;
      --muted: #9ca3af;
      --glass: rgba(20,25,34,0.6);
      color-scheme: dark;
    }
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    html, body {
      height: 100%;
      overflow-x: hidden;
    }
    body {
      background: linear-gradient(180deg, var(--bg), #f1f5f9);
      min-height: 100vh;
      color: #0f1724;
      padding: 0;
      transition: background .25s, color .25s;
      -webkit-font-smoothing: antialiased;
      display: flex;
      flex-direction: column;
    }
    .dark-mode {
      color: #e2e8f0;
    }
    .dark-mode input,
    .dark-mode textarea,
    .dark-mode select {
      color: #e2e8f0;
      border-color: rgba(255,255,255,0.1);
    }
    /* Container */
    .container {
      max-width: 100%;
      margin: 0 auto;
      padding: 12px;
      width: 100%;
      flex: 1;
    }
    /* Header */
    header {
      position: sticky;
      top: 12px;
      z-index: 40;
      margin-bottom: 18px;
      background: linear-gradient(180deg, rgba(255,255,255,0.55), rgba(255,255,255,0.40));
      backdrop-filter: blur(8px) saturate(120%);
      border-radius: 14px;
      box-shadow: var(--shadow);
      padding: 12px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      border: 1px solid rgba(16,24,40,0.04);
      flex-wrap: wrap;
    }
    .dark-mode header {
      background: linear-gradient(180deg, var(--glass), rgba(255,255,255,0.02));
      border: 1px solid rgba(255,255,255,0.04);
      color: #e2e8f0;
    }
    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .logo {
      width: 44px;
      height: 44px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      background: linear-gradient(135deg, var(--primary), var(--primary-600));
      color: white;
      box-shadow: 0 6px 18px rgba(59,130,246,0.18);
      flex-shrink: 0;
    }
    h1 {
      font-size: 18px;
      margin: 0;
    }
    .header-actions {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }
    .badge {
      min-width: 26px;
      height: 26px;
      border-radius: 999px;
      background: var(--danger);
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 13px;
      box-shadow: 0 4px 10px rgba(239,68,68,0.18);
    }
    .btn {
      background: var(--primary);
      color: #fff;
      padding: 10px 16px;
      border-radius: 10px;
      border: 0;
      font-weight: 600;
      cursor: pointer;
      font-size: 14px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .icon-btn {
      background: transparent;
      border: 1px solid rgba(0,0,0,0.06);
      padding: 8px;
      border-radius: 10px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .dark-mode .icon-btn {
      border-color: rgba(255,255,255,0.04);
    }
    /* Form Section */
    .form-section {
      background: var(--card);
      border-radius: 16px;
      padding: 16px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(16,24,40,0.04);
      margin-bottom: 16px;
    }
    /* Form Fields */
    .field {
      position: relative;
      margin-bottom: 16px;
    }
    .field input,
    .field textarea,
    .field select {
      width: 100%;
      padding: 16px 14px;
      border-radius: 10px;
      border: 1px solid rgba(16,24,40,0.06);
      background: transparent;
      font-size: 16px;
      color: inherit;
    }
    .field textarea {
      resize: vertical;
      min-height: 100px;
    }
    .field label {
      position: absolute;
      left: 14px;
      top: 16px;
      font-size: 14px;
      color: var(--muted);
      pointer-events: none;
      transition: transform .15s, font-size .15s, top .15s;
      background: transparent;
      padding: 0 4px;
    }
    .field input:focus + label,
    .field input:not(:placeholder-shown) + label,
    .field textarea:focus + label,
    .field textarea:not(:placeholder-shown) + label,
    .field select:focus + label,
    .field select:not([value=""]):valid + label {
      top: -8px;
      transform: translateY(0);
      font-size: 12px;
      color: var(--primary);
      background: var(--card);
      z-index: 1;
    }
    .controls {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }
    /* Filter Section */
    .filter-section {
      display: flex;
      gap: 8px;
      margin: 14px 0 18px;
      flex-wrap: nowrap;
      overflow-x: auto;
      padding-bottom: 8px;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }
    .filter-section::-webkit-scrollbar {
      display: none;
    }
    .filter-btn {
      padding: 10px 16px;
      border-radius: 999px;
      border: 1px solid rgba(16,24,40,0.04);
      background: transparent;
      cursor: pointer;
      font-size: 14px;
      white-space: nowrap;
      flex-shrink: 0;
    }
    .filter-btn.active {
      background: var(--primary);
      color: #fff;
      border-color: var(--primary);
    }
    .search-box {
      flex: 1;
      padding: 12px 14px;
      border-radius: 10px;
      border: 1px solid rgba(16,24,40,0.06);
      min-width: 120px;
      font-size: 16px;
    }
    /* Tasks Container */
    .tasks-container {
      display: flex;
      flex-direction: column;
      gap: 14px;
      margin-top: 8px;
      padding-bottom: 80px;
    }
    .subject-header {
      display: flex;
      align-items: center;
      gap: 10px;
      justify-content: space-between;
      padding: 8px 12px;
      background: transparent;
    }
    .task-card {
      background: var(--card);
      padding: 16px;
      border-radius: 12px;
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      gap: 12px;
      border-left: 6px solid var(--primary);
      transition: transform .12s, box-shadow .12s;
      position: relative;
      overflow: hidden;
    }
    .task-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(16,24,40,0.1);
    }
    .task-title {
      font-weight: 700;
      font-size: 18px;
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .task-detail {
      font-size: 14px;
      color: var(--muted);
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }
    .task-actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
      margin-top: 8px;
    }
    .status-pill {
      position: absolute;
      top: 12px;
      right: 12px;
      padding: 4px 10px;
      border-radius: 999px;
      font-weight: 700;
      font-size: 12px;
    }
    /* Priority classes */
    .priority-high { border-left-color: var(--priority-high); }
    .priority-medium { border-left-color: var(--priority-medium); }
    .priority-low { border-left-color: var(--priority-low); }
    /* Deadline color classes */
    .dl-ok { border-left-color: var(--success); }
    .dl-soon { border-left-color: var(--warning); }
    .dl-urgent { border-left-color: var(--danger); }
    .dl-overdue { border-left-color: #6b7280; opacity: 0.85; }
    /* Priority badge */
    .priority-badge {
      padding: 4px 10px;
      border-radius: 10px;
      font-size: 12px;
      font-weight: 700;
    }
    .priority-high-badge {
      background-color: var(--priority-high);
      color: white;
    }
    .priority-medium-badge {
      background-color: var(--priority-medium);
      color: white;
    }
    .priority-low-badge {
      background-color: var(--priority-low);
      color: white;
    }
    /* FAB */
    .fab {
      position: fixed;
      right: 20px;
      bottom: calc(20px + env(safe-area-inset-bottom));
      width: 60px;
      height: 60px;
      border-radius: 999px;
      background: linear-gradient(135deg, var(--primary), var(--primary-600));
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-size: 24px;
      box-shadow: 0 18px 40px rgba(59,130,246,0.22);
      cursor: pointer;
      border: 0;
      z-index: 60;
    }
    /* Toast */
    .toast {
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 100px;
      background: #111;
      color: #fff;
      padding: 12px 18px;
      border-radius: 10px;
      opacity: 0;
      pointer-events: none;
      transition: opacity .2s;
      z-index: 80;
      font-size: 14px;
      text-align: center;
      max-width: 80%;
    }
    .toast.show {
      opacity: 1;
      pointer-events: auto;
    }
    /* Watermark */
    .watermark {
      position: fixed;
      left: 12px;
      bottom: 12px;
      font-size: 12px;
      color: var(--muted);
      opacity: 0.28;
      pointer-events: none;
      z-index: 70;
      background: transparent;
      padding: 4px 6px;
      border-radius: 8px;
    }
    .dark-mode .watermark {
      color: #cbd5e1;
      opacity: 0.18;
    }
    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--muted);
    }
    .empty-state img {
      max-width: 100%;
      margin-bottom: 16px;
      opacity: 0.5;
    }
    /* Responsive adjustments */
    @media (max-width: 768px) {
      .container {
        padding: 10px;
      }
      header {
        position: relative;
        top: 0;
        margin-bottom: 12px;
        padding: 10px;
      }
      .logo {
        width: 40px;
        height: 40px;
        font-size: 18px;
      }
      h1 {
        font-size: 16px;
      }
      .header-actions {
        gap: 8px;
      }
      .form-section {
        padding: 14px;
      }
      .field input,
      .field textarea,
      .field select {
        padding: 14px 12px;
        font-size: 16px; /* Prevent zoom on iOS */
      }
      .filter-btn {
        padding: 8px 14px;
        font-size: 14px;
      }
      .search-box {
        padding: 10px 12px;
        font-size: 16px; /* Prevent zoom on iOS */
      }
      .task-card {
        padding: 14px;
      }
      .task-title {
        font-size: 16px;
      }
      .task-detail {
        font-size: 13px;
      }
      .fab {
        right: 16px;
        bottom: calc(16px + env(safe-area-inset-bottom));
        width: 56px;
        height: 56px;
        font-size: 22px;
      }
    }
    @media (max-width: 480px) {
      .brand {
        gap: 8px;
      }
      .header-actions {
        justify-content: flex-end;
        width: 100%;
        margin-top: 8px;
      }
      .controls {
        justify-content: space-between;
        width: 100%;
      }
      .filter-section {
        gap: 6px;
      }
      .filter-btn {
        padding: 8px 12px;
        font-size: 13px;
      }
    }
    /* Focus styles */
    :focus {
      outline: 3px solid rgba(59,130,246,0.12);
      outline-offset: 2px;
    }
    /* Animation for urgent tasks */
    @keyframes blink {
      0% { opacity: 1; }
      50% { opacity: 0.6; }
      100% { opacity: 1; }
    }
    .blink {
      animation: blink 1.5s infinite;
    }
  </style>
</head>
<body>
  <!-- Splash screen -->
  <div id="splash">
    <video autoplay muted playsinline id="introVideo">
      <source src="intro.mp4" type="video/mp4">
      Browser kamu tidak mendukung video.
    </video>
  </div>
  <!-- Konten utama -->
  <div id="mainContent">
    <div class="container" role="main" id="appRoot">
      <header aria-label="Header aplikasi">
        <div class="brand">
          <div class="logo" aria-hidden="true">📝</div>
          <div>
            <h1>Pengingat PR</h1>
            <div style="font-size:12px;color:var(--muted)">Kelola tugas sekolahmu dengan rapi</div>
          </div>
        </div>
        <div class="header-actions" role="toolbar">
          <button id="exportBtn" class="icon-btn" title="Ekspor data tugas">📤</button>
          <button id="importBtn" class="icon-btn" title="Impor data tugas">📥</button>
          <div id="newTasksBadge" class="badge" aria-live="polite" style="display: none;">0</div>
          <button id="themeToggle" class="icon-btn" title="Toggle Tema (dark/light)" aria-pressed="false">🌙</button>
        </div>
      </header>
      <section class="form-section" aria-labelledby="formTitle">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;gap:12px;flex-wrap:wrap">
          <strong id="formTitle" style="font-size:18px;">Tambah Tugas</strong>
          <div class="controls">
            <button id="openFormBtn" class="btn" aria-expanded="false">➕ Tambah</button>
            <button id="clearAll" class="filter-btn" title="Hapus semua tugas">🗑️ Hapus Semua</button>
          </div>
        </div>
        <form id="taskForm" style="display:none" aria-hidden="true" novalidate>
          <div style="display:grid;grid-template-columns:1fr;gap:12px">
            <div class="field">
              <input id="taskSubject" placeholder=" " required />
              <label for="taskSubject">Mata Pelajaran</label>
            </div>
            <div class="field">
              <input id="taskDeadline" type="datetime-local" placeholder=" " required />
              <label for="taskDeadline">Deadline</label>
            </div>
          </div>
          <div class="field">
            <input id="taskName" placeholder=" " required />
            <label for="taskName">Deskripsi Tugas</label>
          </div>
          <div class="field">
            <textarea id="taskNotes" placeholder=" "></textarea>
            <label for="taskNotes">Catatan (opsional)</label>
          </div>
          <div class="field">
            <select id="taskPriority" required>
              <option value="medium">Prioritas Medium</option>
              <option value="high">Prioritas High</option>
              <option value="low">Prioritas Low</option>
            </select>
            <label for="taskPriority">Tingkat Prioritas</label>
          </div>
          <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:16px">
            <button type="submit" class="btn">💾 Simpan</button>
            <button type="button" id="cancelForm" class="filter-btn">❌ Batal</button>
          </div>
        </form>
      </section>
      <div class="filter-section" role="region" aria-label="Filter tugas">
        <button class="filter-btn active" data-filter="all">Semua</button>
        <button class="filter-btn" data-filter="new">Baru</button>
        <button class="filter-btn" data-filter="active">Belum Selesai</button>
        <button class="filter-btn" data-filter="done">Selesai</button>
        <button class="filter-btn" data-filter="today">Hari Ini</button>
        <button class="filter-btn" data-filter="tomorrow">Besok</button>
        <button class="filter-btn" data-filter="week">Minggu Ini</button>
        <button class="filter-btn" data-filter="overdue">Terlambat</button>
        <input id="searchBox" class="search-box" placeholder="Cari tugas..." aria-label="Cari tugas" />
      </div>
      <section id="tasksContainer" class="tasks-container" aria-live="polite" aria-atomic="true">
        <div class="empty-state">
          <div style="font-size:48px;margin-bottom:16px;">📚</div>
          <h3>Belum ada tugas</h3>
          <p>Tambahkan tugas baru dengan menekan tombol "+" di bawah</p>
        </div>
      </section>
    </div>
    <button id="fab" class="fab" title="Tambah tugas cepat" aria-label="Tambah tugas cepat">+</button>
    <div id="toast" class="toast" role="status" aria-live="polite"></div>
    <div class="watermark" aria-hidden="true">by : Rahmat</div>
  </div>

  <script>
    // Splash screen handler
    const splash = document.getElementById("splash");
    const video = document.getElementById("introVideo");
    const mainContent = document.getElementById("mainContent");

    // Fungsi untuk menyembunyikan splash screen
    function hideSplash() {
        splash.style.display = "none";
        mainContent.style.display = "block";
    }

    // Event ketika video selesai
    video.onended = hideSplash;

    // Event ketika video error
    video.onerror = () => {
        console.log("Video error, skipping to main content");
        hideSplash();
    };

    // Event klik pada splash screen untuk skip
    splash.addEventListener('click', hideSplash);

    // Fallback timeout (dikurangi menjadi 3 detik untuk testing)
    setTimeout(() => {
        if (splash.style.display !== "none") {
            console.log("Splash timeout, showing main content");
            hideSplash();
        }
    }, 3000); // 3 detik fallback

    // Existing application code
    (function(){
      // State management
      let tasks = [];
      let currentFilter = 'all';
      let searchQuery = '';
      let darkMode = localStorage.getItem('darkMode') === 'true';
      const STORAGE_KEY = 'pr_tasks_v3';
      // DOM elements
      const taskForm = document.getElementById('taskForm');
      const openFormBtn = document.getElementById('openFormBtn');
      const cancelForm = document.getElementById('cancelForm');
      const tasksContainer = document.getElementById('tasksContainer');
      const newTasksBadge = document.getElementById('newTasksBadge');
      const searchBox = document.getElementById('searchBox');
      const filterBtns = document.querySelectorAll('.filter-btn[data-filter]');
      const themeToggle = document.getElementById('themeToggle');
      const fab = document.getElementById('fab');
      const clearAllBtn = document.getElementById('clearAll');
      const toastEl = document.getElementById('toast');
      const exportBtn = document.getElementById('exportBtn');
      const importBtn = document.getElementById('importBtn');
      // Initialize theme
      function initTheme() {
        if (darkMode) {
          document.body.classList.add('dark-mode');
          themeToggle.textContent = '☀️';
          themeToggle.setAttribute('aria-pressed', 'true');
        } else {
          document.body.classList.remove('dark-mode');
          themeToggle.textContent = '🌙';
          themeToggle.setAttribute('aria-pressed', 'false');
        }
      }
      // Set minimum datetime for deadline field
      function setMinDeadline() {
        const now = new Date();
        const pad = n => String(n).padStart(2, '0');
        const minDateTime = `${now.getFullYear()}-${pad(now.getMonth() + 1)}-${pad(now.getDate())}T${pad(now.getHours())}:${pad(now.getMinutes())}`;
        const deadlineField = document.getElementById('taskDeadline');
        if (deadlineField) {
          deadlineField.min = minDateTime;
        }
      }
      // Load tasks from localStorage
      function loadTasks() {
        try {
          const storedTasks = localStorage.getItem(STORAGE_KEY);
          tasks = storedTasks ? JSON.parse(storedTasks) : [];
          // Migrate from older versions if needed
          tasks = tasks.map(task => {
            if (!task.hasOwnProperty('priority')) {
              task.priority = 'medium';
            }
            return task;
          });
        } catch (error) {
          console.error('Error loading tasks:', error);
          tasks = [];
          showToast('Gagal memuat tugas');
        }
        updateBadge();
        renderTasks();
      }
      // Save tasks to localStorage
      function saveTasks() {
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(tasks));
        } catch (error) {
          console.error('Error saving tasks:', error);
          showToast('Gagal menyimpan tugas');
        }
      }
      // Show toast notification
      let toastTimeout = null;
      function showToast(message, duration = 3000) {
        if (toastTimeout) {
          clearTimeout(toastTimeout);
        }
        toastEl.textContent = message;
        toastEl.classList.add('show');
        toastTimeout = setTimeout(() => {
          toastEl.classList.remove('show');
        }, duration);
      }
      // Generate unique ID
      function generateId() {
        return Date.now() + Math.floor(Math.random() * 1000);
      }
      // Calculate time left class for deadline
      function getTimeLeftClass(deadline) {
        const now = Date.now();
        const deadlineTime = new Date(deadline).getTime();
        if (isNaN(deadlineTime)) return 'dl-ok';
        const timeDiff = deadlineTime - now;
        const oneDay = 24 * 60 * 60 * 1000;
        if (timeDiff < 0) return 'dl-overdue';
        if (timeDiff <= oneDay) return 'dl-urgent';
        if (timeDiff <= 3 * oneDay) return 'dl-soon';
        return 'dl-ok';
      }
      // Format relative time
      function formatRelativeTime(deadline) {
        const deadlineDate = new Date(deadline);
        if (isNaN(deadlineDate)) return '-';
        const now = Date.now();
        const timeDiff = deadlineDate.getTime() - now;
        const absTimeDiff = Math.abs(timeDiff);
        const oneDay = 24 * 60 * 60 * 1000;
        if (timeDiff < 0) {
          const daysAgo = Math.ceil(absTimeDiff / oneDay);
          return `${daysAgo} hari yang lalu`;
        }
        if (timeDiff < 60000) return 'Beberapa detik lagi';
        if (timeDiff < 3600000) return `${Math.ceil(timeDiff / 60000)} menit lagi`;
        if (timeDiff < oneDay) return `${Math.ceil(timeDiff / 3600000)} jam lagi`;
        const daysLeft = Math.ceil(timeDiff / oneDay);
        return `${daysLeft} hari lagi`;
      }
      // Check if date is today
      function isToday(date) {
        const today = new Date();
        return date.getDate() === today.getDate() &&
               date.getMonth() === today.getMonth() &&
               date.getFullYear() === today.getFullYear();
      }
      // Check if date is tomorrow
      function isTomorrow(date) {
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        return date.getDate() === tomorrow.getDate() &&
               date.getMonth() === tomorrow.getMonth() &&
               date.getFullYear() === tomorrow.getFullYear();
      }
      // Check if date is within this week
      function isThisWeek(date) {
        const today = new Date();
        const startOfWeek = new Date(today);
        startOfWeek.setDate(today.getDate() - today.getDay());
        const endOfWeek = new Date(today);
        endOfWeek.setDate(today.getDate() + (6 - today.getDay()));
        return date >= startOfWeek && date <= endOfWeek;
      }
      // Check if task is overdue
      function isOverdue(deadline) {
        return new Date(deadline) < new Date();
      }
      // Update new tasks badge
      function updateBadge() {
        const newTasksCount = tasks.filter(task => task.status === 'new').length;
        newTasksBadge.textContent = newTasksCount;
        if (newTasksCount > 0) {
          newTasksBadge.style.display = 'flex';
        } else {
          newTasksBadge.style.display = 'none';
        }
      }
      // Toggle form visibility
      function toggleForm(show) {
        const isVisible = taskForm.style.display !== 'none';
        const shouldShow = typeof show === 'boolean' ? show : !isVisible;
        taskForm.style.display = shouldShow ? 'block' : 'none';
        openFormBtn.setAttribute('aria-expanded', shouldShow);
        taskForm.setAttribute('aria-hidden', !shouldShow);
        if (!shouldShow) {
          taskForm.reset();
        }
      }
      // Render tasks based on current filter and search
      function renderTasks() {
        const filteredTasks = tasks.filter(task => {
          // Apply search filter
          if (searchQuery.trim() !== '') {
            const query = searchQuery.toLowerCase();
            const matchesSearch = 
              (task.subject && task.subject.toLowerCase().includes(query)) ||
              (task.name && task.name.toLowerCase().includes(query)) ||
              (task.notes && task.notes.toLowerCase().includes(query));
            if (!matchesSearch) return false;
          }
          // Apply status filter
          switch (currentFilter) {
            case 'new':
              return task.status === 'new';
            case 'active':
              return task.status !== 'done';
            case 'done':
              return task.status === 'done';
            case 'today': {
              const taskDate = new Date(task.deadline);
              return isToday(taskDate) && task.status !== 'done';
            }
            case 'tomorrow': {
              const taskDate = new Date(task.deadline);
              return isTomorrow(taskDate) && task.status !== 'done';
            }
            case 'week': {
              const taskDate = new Date(task.deadline);
              return isThisWeek(taskDate) && task.status !== 'done';
            }
            case 'overdue':
              return isOverdue(task.deadline) && task.status !== 'done';
            default:
              return true;
          }
        });
        // Sort tasks: priority (high > medium > low) then by deadline
        filteredTasks.sort((a, b) => {
          const priorityOrder = { high: 0, medium: 1, low: 2 };
          const priorityCompare = priorityOrder[a.priority] - priorityOrder[b.priority];
          if (priorityCompare !== 0) return priorityCompare;
          return new Date(a.deadline) - new Date(b.deadline);
        });
        // Group tasks by subject
        const tasksBySubject = {};
        filteredTasks.forEach(task => {
          const subject = task.subject || 'Umum';
          if (!tasksBySubject[subject]) {
            tasksBySubject[subject] = [];
          }
          tasksBySubject[subject].push(task);
        });
        // Clear tasks container
        tasksContainer.innerHTML = '';
        // Show empty state if no tasks
        if (filteredTasks.length === 0) {
          const emptyState = document.createElement('div');
          emptyState.className = 'empty-state';
          emptyState.innerHTML = `
            <div style="font-size:48px;margin-bottom:16px;">📚</div>
            <h3>Tidak ada tugas</h3>
            <p>Tidak ada tugas yang sesuai dengan filter Anda</p>
          `;
          tasksContainer.appendChild(emptyState);
          return;
        }
        // Render tasks by subject
        Object.keys(tasksBySubject).sort().forEach(subject => {
          const subjectTasks = tasksBySubject[subject];
          // Create subject header
          const subjectHeader = document.createElement('div');
          subjectHeader.className = 'subject-header';
          subjectHeader.innerHTML = `
            <div style="font-weight:700;font-size:18px;">${subject}</div>
            <div style="font-size:14px;color:var(--muted)">${subjectTasks.length} tugas</div>
          `;
          tasksContainer.appendChild(subjectHeader);
          // Create task cards for this subject
          subjectTasks.forEach(task => {
            const taskCard = document.createElement('article');
            taskCard.className = `task-card priority-${task.priority} ${getTimeLeftClass(task.deadline)}`;
            taskCard.tabIndex = 0;
            taskCard.setAttribute('role', 'article');
            taskCard.dataset.id = task.id;
            // Add blink animation for overdue tasks
            if (isOverdue(task.deadline)) { // Perbaikan: tambahkan kurung kurawal
              taskCard.classList.add('blink');
            }
            // Determine status text and color
            let statusText = '';
            let statusColor = '';
            switch (task.status) {
              case 'new':
                statusText = 'Baru';
                statusColor = 'var(--warning)';
                break;
              case 'opened':
                statusText = 'Dibaca';
                statusColor = 'var(--primary)';
                break;
              case 'done':
                statusText = 'Selesai';
                statusColor = 'var(--success)';
                break;
              default:
                statusText = 'Baru';
                statusColor = 'var(--warning)';
            }
            // Determine priority badge
            let priorityBadgeText = '';
            let priorityBadgeClass = '';
            switch (task.priority) {
              case 'high':
                priorityBadgeText = 'Tinggi';
                priorityBadgeClass = 'priority-high-badge';
                break;
              case 'medium':
                priorityBadgeText = 'Sedang';
                priorityBadgeClass = 'priority-medium-badge';
                break;
              case 'low':
                priorityBadgeText = 'Rendah';
                priorityBadgeClass = 'priority-low-badge';
                break;
            }
            // Create task card content
            taskCard.innerHTML = `
              <div class="status-pill" style="background:${statusColor}">${statusText}</div>
              <div class="task-title">
                ${task.name}
                <span class="priority-badge ${priorityBadgeClass}">${priorityBadgeText}</span>
              </div>
              <div class="task-detail">
                <strong>${task.subject || 'Umum'}</strong> • ${formatRelativeTime(task.deadline)}
              </div>
              ${task.notes ? `<div class="task-detail">${task.notes}</div>` : ''}
              <div class="task-actions">
                ${task.status !== 'done' ? '<button class="icon-btn" data-action="complete" aria-label="Tandai selesai">✓</button>' : ''}
                <button class="icon-btn" data-action="edit" aria-label="Edit tugas">✎</button>
                <button class="icon-btn" data-action="delete" aria-label="Hapus tugas">🗑</button>
              </div>
            `;
            // Add event listeners for task actions
            const actionButtons = taskCard.querySelectorAll('[data-action]');
            actionButtons.forEach(button => {
              button.addEventListener('click', (e) => {
                e.stopPropagation();
                handleTaskAction(task.id, button.dataset.action);
              });
            });
            // Add click event to mark as opened
            taskCard.addEventListener('click', () => {
              if (task.status === 'new') {
                task.status = 'opened';
                saveTasks();
                renderTasks();
                updateBadge();
              }
            });
            tasksContainer.appendChild(taskCard);
          });
        });
      }
      // Handle task actions (complete, edit, delete)
      function handleTaskAction(taskId, action) {
        const taskIndex = tasks.findIndex(task => task.id === taskId);
        if (taskIndex === -1) return;
        switch (action) {
          case 'complete':
            tasks[taskIndex].status = 'done';
            saveTasks();
            renderTasks();
            updateBadge();
            showToast('Tugas ditandai sebagai selesai');
            break;
          case 'edit':
            const task = tasks[taskIndex];
            document.getElementById('taskSubject').value = task.subject || '';
            document.getElementById('taskName').value = task.name || '';
            document.getElementById('taskDeadline').value = task.deadline || '';
            document.getElementById('taskNotes').value = task.notes || '';
            document.getElementById('taskPriority').value = task.priority || 'medium';
            tasks.splice(taskIndex, 1);
            saveTasks();
            updateBadge();
            toggleForm(true);
            window.scrollTo({ top: 0, behavior: 'smooth' });
            showToast('Edit tugas');
            break;
          case 'delete':
            if (confirm('Apakah Anda yakin ingin menghapus tugas ini?')) {
              tasks.splice(taskIndex, 1);
              saveTasks();
              renderTasks();
              updateBadge();
              showToast('Tugas dihapus');
            }
            break;
        }
      }
      // Export tasks to JSON
      function exportTasks() {
        const dataStr = JSON.stringify(tasks, null, 2);
        const dataUri = 'application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
        const exportFileDefaultName = 'tugas-pr.json';
        const linkElement = document.createElement('a');
        linkElement.setAttribute('href', dataUri);
        linkElement.setAttribute('download', exportFileDefaultName);
        linkElement.click();
        showToast('Tugas berhasil diekspor');
      }
      // Import tasks from JSON
      function importTasks() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        input.onchange = e => {
          const file = e.target.files[0];
          const reader = new FileReader();
          reader.onload = function(e) {
            try {
              const importedTasks = JSON.parse(e.target.result);
              if (Array.isArray(importedTasks)) {
                if (confirm('Impor data akan menggantikan semua tugas yang ada. Lanjutkan?')) {
                  tasks = importedTasks;
                  saveTasks();
                  renderTasks();
                  updateBadge();
                  showToast('Tugas berhasil diimpor');
                }
              } else {
                showToast('Format file tidak valid');
              }
            } catch (error) {
              console.error('Error importing tasks:', error);
              showToast('Gagal mengimpor tugas');
            }
          };
          reader.readAsText(file);
        };
        input.click();
      }
      // Initialize event listeners
      function initEventListeners() {
        // Form submission
        taskForm.addEventListener('submit', function(e) {
          e.preventDefault();
          const subject = document.getElementById('taskSubject').value.trim();
          const name = document.getElementById('taskName').value.trim();
          const deadline = document.getElementById('taskDeadline').value;
          const notes = document.getElementById('taskNotes').value.trim();
          const priority = document.getElementById('taskPriority').value;
          if (!subject || !name || !deadline) {
            showToast('Harap isi semua field yang diperlukan');
            return;
          }
          const newTask = {
            id: generateId(),
            subject,
            name,
            deadline,
            notes,
            priority,
            status: 'new',
            createdAt: Date.now()
          };
          tasks.unshift(newTask);
          saveTasks();
          toggleForm(false);
          renderTasks();
          updateBadge();
          showToast('Tugas berhasil ditambahkan');
        });
        // Form toggle
        openFormBtn.addEventListener('click', () => toggleForm(true));
        fab.addEventListener('click', () => toggleForm(true));
        cancelForm.addEventListener('click', () => toggleForm(false));
        // Filter buttons
        filterBtns.forEach(btn => {
          btn.addEventListener('click', () => {
            filterBtns.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentFilter = btn.dataset.filter;
            renderTasks();
          });
        });
        // Search box
        let searchDebounce;
        searchBox.addEventListener('input', (e) => {
          clearTimeout(searchDebounce);
          searchDebounce = setTimeout(() => {
            searchQuery = e.target.value;
            renderTasks();
          }, 300);
        });
        // Theme toggle
        themeToggle.addEventListener('click', () => {
          darkMode = !darkMode;
          document.body.classList.toggle('dark-mode', darkMode);
          localStorage.setItem('darkMode', darkMode);
          themeToggle.textContent = darkMode ? '☀️' : '🌙';
          themeToggle.setAttribute('aria-pressed', darkMode);
          showToast(`Mode ${darkMode ? 'gelap' : 'terang'} diaktifkan`);
        });
        // Clear all tasks
        clearAllBtn.addEventListener('click', () => {
          if (tasks.length === 0) {
            showToast('Tidak ada tugas untuk dihapus');
            return;
          }
          if (confirm('Apakah Anda yakin ingin menghapus semua tugas? Tindakan ini tidak dapat dibatalkan.')) {
            tasks = [];
            saveTasks();
            renderTasks();
            updateBadge();
            showToast('Semua tugas telah dihapus');
          }
        });
        // Export/Import
        exportBtn.addEventListener('click', exportTasks);
        importBtn.addEventListener('click', importTasks);
        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
          // Ctrl+K or Cmd+K for search
          if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
            e.preventDefault();
            searchBox.focus();
          }
          // N for new task when not in input field
          if (e.key === 'n' && !['INPUT', 'TEXTAREA', 'SELECT'].includes(document.activeElement.tagName)) {
            e.preventDefault();
            toggleForm(true);
          }
        });
      }
      // Initialize the application
      function init() {
        initTheme();
        setMinDeadline();
        loadTasks();
        initEventListeners();
        showToast('Aplikasi siap digunakan', 2000);
      }
      // Start the application when DOM is loaded
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        init();
      }
    })();
  </script>
</body>
</html>